<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì§„ì£¼â™¥ë™ìš± ì‚¬ë‹¤ë¦¬ ê²Œì„</title>
    <style>
        /* ê¸°ë³¸ ë¦¬ì…‹ ë° í°íŠ¸ ì„¤ì • */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2, #9c88ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .couple-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
        }

        /* ë©”ì¸ ê²Œì„ ì˜ì—­ */
        .game-area {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
            padding: 30px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* ì…ë ¥ ì„¹ì…˜ */
        .input-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #444;
            text-align: center;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .option-text {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            outline: none;
        }

        .option-text:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .option-text::placeholder {
            color: #a5b3ff;
        }

        /* ë²„íŠ¼ ì˜ì—­ */
        .button-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            text-transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #fff0f0;
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
        }

        .btn-secondary:hover {
            background: #ff6b6b;
            color: white;
        }

        .add-remove-buttons {
            display: flex;
            gap: 12px;
        }

        .add-remove-buttons .btn {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
        }

        /* ê²Œì„ ìº”ë²„ìŠ¤ ì˜ì—­ */
        .game-canvas-area {
            display: none;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-height: 400px;
        }

        .game-canvas-area.active {
            display: flex;
        }

        #gameCanvas {
            border: 2px solid #ffe0e0;
            border-radius: 12px;
            background: #fafafa;
            max-width: 100%;
            height: auto;
        }

        .game-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 300px;
        }

        /* ê²°ê³¼ ì˜ì—­ */
        .result-area {
            display: none;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fff0f0 0%, #ffe8e8 100%);
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #ffe0e0;
        }

        .result-area.active {
            display: block;
        }

        .result-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .result-option {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff6b6b;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(255,107,107,0.2);
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .title {
                font-size: 2rem;
            }

            .couple-name {
                font-size: 1.5rem;
            }

            .game-area {
                padding: 20px 15px;
            }

            .option-number {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .option-text {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
            }
            100% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            }
        }

        .heart-beat {
            animation: heartBeat 1.5s ease-in-out infinite;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }

        /* PWA ì„¤ì¹˜ ë²„íŠ¼ */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
            font-size: 0.9rem;
        }

        .install-prompt:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .install-prompt.show {
            display: block;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ì˜¤í”„ë¼ì¸ í‘œì‹œ */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: none;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        .offline-indicator.show {
            display: block;
        }

        /* íˆìŠ¤í† ë¦¬ ë²„íŠ¼ */
        .history-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 1px solid #e0e6ff;
        }

        .history-title {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e0e6ff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .history-item:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .history-item-date {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .clear-history-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .clear-history-btn:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        /* ì„ì‹œ ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* í–¥ìƒëœ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .history-list::-webkit-scrollbar {
            width: 4px;
        }

        .history-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 2px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì˜¤í”„ë¼ì¸ í‘œì‹œ -->
        <div class="offline-indicator" id="offlineIndicator">
            ğŸ“µ ì˜¤í”„ë¼ì¸ ëª¨ë“œ
        </div>

        <!-- PWA ì„¤ì¹˜ ë²„íŠ¼ -->
        <button class="install-prompt" id="installPrompt">
            ğŸ“± í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°
        </button>

        <!-- í—¤ë” -->
        <header class="header">
            <h1 class="title">ğŸ’• ì‚¬ë‹¤ë¦¬ ê²Œì„</h1>
            <div class="couple-name heart-beat">JJâ™¥UK</div>
            <p class="subtitle">ìš°ë¦¬ë§Œì˜ íŠ¹ë³„í•œ ì„ íƒ ê²Œì„ ğŸ’–</p>
        </header>

        <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
        <main class="game-area">
            <!-- ì…ë ¥ ì„¹ì…˜ -->
            <section class="input-section" id="inputSection">
                <h2 class="section-title">ğŸ’ ì˜¤ëŠ˜ì˜ ì„ íƒì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</h2>
                
                <div class="options-container" id="optionsContainer">
                    <div class="option-input">
                        <div class="option-number">1</div>
                        <input type="text" class="option-text" placeholder="ì˜ˆ: í•œì‹ë‹¹ ğŸš" maxlength="20">
                    </div>
                    <div class="option-input">
                        <div class="option-number">2</div>
                        <input type="text" class="option-text" placeholder="ì˜ˆ: ì¤‘ì‹ë‹¹ ğŸ¥Ÿ" maxlength="20">
                    </div>
                    <div class="option-input">
                        <div class="option-number">3</div>
                        <input type="text" class="option-text" placeholder="ì˜ˆ: ì¼ì‹ë‹¹ ğŸ£" maxlength="20">
                    </div>
                </div>

                <div class="add-remove-buttons">
                    <button class="btn btn-secondary" id="removeOptionBtn">ì„ íƒì§€ ì œê±° â–</button>
                    <button class="btn btn-secondary" id="addOptionBtn">ì„ íƒì§€ ì¶”ê°€ â•</button>
                </div>

                <div class="button-area">
                    <button class="btn btn-primary pulse" id="startGameBtn">
                        ğŸ’– ì‚¬ë‹¤ë¦¬ ê²Œì„ ì‹œì‘!
                    </button>
                </div>

                <!-- íˆìŠ¤í† ë¦¬ ì„¹ì…˜ -->
                <div class="history-section" id="historySection">
                    <div class="history-title">ğŸ• ìµœê·¼ ì„ íƒì§€</div>
                    <div class="history-list" id="historyList"></div>
                    <button class="clear-history-btn" id="clearHistoryBtn" style="display: none;">
                        ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ
                    </button>
                </div>
            </section>

            <!-- ê²Œì„ ìº”ë²„ìŠ¤ ì˜ì—­ -->
            <section class="game-canvas-area" id="gameCanvasArea">
                <canvas id="gameCanvas" width="350" height="400"></canvas>
                <div class="game-controls">
                    <button class="btn btn-primary" id="runLadderBtn">
                        ğŸƒâ€â™€ï¸ğŸ’¨ JJâ™¥UK ì¶œë°œ!
                    </button>
                    <button class="btn btn-secondary" id="newGameBtn">
                        ğŸ”„ ìƒˆ ê²Œì„
                    </button>
                </div>
            </section>

            <!-- ê²°ê³¼ ì˜ì—­ -->
            <section class="result-area" id="resultArea">
                <div class="result-text">ğŸ‰ JJâ™¥UKì˜ ì„ íƒ!</div>
                <div class="result-option" id="resultOption"></div>
                <div class="button-area">
                    <button class="btn btn-primary" id="playAgainBtn">
                        ğŸ² ë‹¤ì‹œ ì„ íƒí•˜ê¸°
                    </button>
                    <button class="btn btn-secondary" id="changeOptionsBtn">
                        âœï¸ ì„ íƒì§€ ë³€ê²½
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ì»¤í”Œ ì „ìš© ì‚¬ë‹¤ë¦¬ ê²Œì„ with PWA
        class CoupleLadderGame {
            constructor() {
                this.options = [];
                this.ladderData = null;
                this.canvas = null;
                this.ctx = null;
                this.isAnimating = false;
                this.selectedPath = [];
                this.currentStep = 0;
                this.deferredPrompt = null;
                this.history = [];
                
                this.initializeElements();
                this.bindEvents();
                this.initializePWA();
                this.loadHistory();
                this.updateUI();
                this.checkNetworkStatus();
            }

            initializeElements() {
                // ê¸°ì¡´ DOM ìš”ì†Œë“¤
                this.inputSection = document.getElementById('inputSection');
                this.gameCanvasArea = document.getElementById('gameCanvasArea');
                this.resultArea = document.getElementById('resultArea');
                this.optionsContainer = document.getElementById('optionsContainer');
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // ê¸°ì¡´ ë²„íŠ¼ë“¤
                this.addOptionBtn = document.getElementById('addOptionBtn');
                this.removeOptionBtn = document.getElementById('removeOptionBtn');
                this.startGameBtn = document.getElementById('startGameBtn');
                this.runLadderBtn = document.getElementById('runLadderBtn');
                this.newGameBtn = document.getElementById('newGameBtn');
                this.playAgainBtn = document.getElementById('playAgainBtn');
                this.changeOptionsBtn = document.getElementById('changeOptionsBtn');
                
                // ìƒˆë¡œìš´ PWA ë° íˆìŠ¤í† ë¦¬ ìš”ì†Œë“¤
                this.installPrompt = document.getElementById('installPrompt');
                this.offlineIndicator = document.getElementById('offlineIndicator');
                this.historySection = document.getElementById('historySection');
                this.historyList = document.getElementById('historyList');
                this.clearHistoryBtn = document.getElementById('clearHistoryBtn');
                
                // ê²°ê³¼ í‘œì‹œ
                this.resultOption = document.getElementById('resultOption');
            }

            // PWA ì´ˆê¸°í™”
            initializePWA() {
                this.createManifest();
                this.registerServiceWorker();
                this.setupInstallPrompt();
            }

            createManifest() {
                const manifest = {
                    name: "JJâ™¥UK ì‚¬ë‹¤ë¦¬ ê²Œì„",
                    short_name: "JJâ™¥UK ì‚¬ë‹¤ë¦¬",
                    description: "JJâ™¥UKë§Œì˜ íŠ¹ë³„í•œ ì‚¬ë‹¤ë¦¬ ê²Œì„",
                    start_url: "/",
                    display: "standalone",
                    background_color: "#667eea",
                    theme_color: "#667eea",
                    orientation: "portrait",
                    icons: [
                        {
                            src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23667eea' rx='20'/><text x='96' y='140' font-size='120' text-anchor='middle' fill='white'>ğŸ’•</text></svg>",
                            sizes: "192x192",
                            type: "image/svg+xml",
                            purpose: "any maskable"
                        },
                        {
                            src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23667eea' rx='60'/><text x='256' y='380' font-size='320' text-anchor='middle' fill='white'>ğŸ’•</text></svg>",
                            sizes: "512x512",
                            type: "image/svg+xml",
                            purpose: "any maskable"
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.getElementById('manifest-placeholder').href = manifestURL;
            }

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    // Service Worker ì½”ë“œë¥¼ ì¸ë¼ì¸ìœ¼ë¡œ ìƒì„±
                    const swCode = `
                        const CACHE_NAME = 'jj-uk-ladder-v1';
                        const urlsToCache = [
                            '/',
                            '/index.html'
                        ];

                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => cache.addAll(urlsToCache))
                            );
                        });

                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        if (response) {
                                            return response;
                                        }
                                        return fetch(event.request);
                                    })
                            );
                        });
                    `;

                    const swBlob = new Blob([swCode], { type: 'application/javascript' });
                    const swURL = URL.createObjectURL(swBlob);
                    
                    navigator.serviceWorker.register(swURL)
                        .then(registration => {
                            console.log('SW ë“±ë¡ ì„±ê³µ:', registration);
                        })
                        .catch(error => {
                            console.log('SW ë“±ë¡ ì‹¤íŒ¨:', error);
                        });
                }
            }

            setupInstallPrompt() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.installPrompt.classList.add('show');
                });

                this.installPrompt.addEventListener('click', () => {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        this.deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('ì•± ì„¤ì¹˜ë¨');
                            }
                            this.deferredPrompt = null;
                            this.installPrompt.classList.remove('show');
                        });
                    }
                });

                window.addEventListener('appinstalled', () => {
                    this.installPrompt.classList.remove('show');
                });
            }

            checkNetworkStatus() {
                const updateOnlineStatus = () => {
                    if (navigator.onLine) {
                        this.offlineIndicator.classList.remove('show');
                    } else {
                        this.offlineIndicator.classList.add('show');
                    }
                };

                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                updateOnlineStatus();
            }

            // íˆìŠ¤í† ë¦¬ ê´€ë¦¬
            loadHistory() {
                try {
                    const saved = localStorage.getItem('jj-uk-ladder-history');
                    this.history = saved ? JSON.parse(saved) : [];
                    this.updateHistoryDisplay();
                } catch (e) {
                    this.history = [];
                }
            }

            saveHistory() {
                try {
                    localStorage.setItem('jj-uk-ladder-history', JSON.stringify(this.history));
                } catch (e) {
                    console.log('íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨');
                }
            }

            addToHistory(options) {
                const historyItem = {
                    options: [...options],
                    date: new Date().toLocaleString('ko-KR', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    timestamp: Date.now()
                };

                // ì¤‘ë³µ ì œê±° (ë™ì¼í•œ ì„ íƒì§€ ì¡°í•©)
                this.history = this.history.filter(item => 
                    JSON.stringify(item.options.sort()) !== JSON.stringify(options.sort())
                );

                this.history.unshift(historyItem);
                this.history = this.history.slice(0, 5); // ìµœëŒ€ 5ê°œê¹Œì§€ ì €ì¥
                this.saveHistory();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                if (this.history.length === 0) {
                    this.historyList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ì•„ì§ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    this.clearHistoryBtn.style.display = 'none';
                    return;
                }

                this.historyList.innerHTML = this.history.map(item => `
                    <div class="history-item" data-options='${JSON.stringify(item.options)}'>
                        <div>${item.options.join(', ')}</div>
                        <div class="history-item-date">${item.date}</div>
                    </div>
                `).join('');

                this.clearHistoryBtn.style.display = 'block';

                // íˆìŠ¤í† ë¦¬ ì•„ì´í…œ í´ë¦­ ì´ë²¤íŠ¸
                this.historyList.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const options = JSON.parse(item.dataset.options);
                        this.loadFromHistory(options);
                    });
                });
            }

            loadFromHistory(options) {
                // ê¸°ì¡´ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                this.optionsContainer.innerHTML = '';
                
                // ì„ íƒì§€ë§Œí¼ ì…ë ¥ í•„ë“œ ìƒì„±
                options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option-input fade-in';
                    optionElement.innerHTML = `
                        <div class="option-number">${index + 1}</div>
                        <input type="text" class="option-text" value="${option}" maxlength="20">
                    `;
                    this.optionsContainer.appendChild(optionElement);
                });

                this.updateUI();
                
                // ì„±ê³µ í”¼ë“œë°±
                this.showTemporaryMessage('íˆìŠ¤í† ë¦¬ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ğŸ’•');
            }

            showTemporaryMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #667eea;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-weight: 600;
                    z-index: 1001;
                    animation: fadeInOut 2s ease-in-out;
                `;
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 2000);
            }

            clearHistory() {
                this.history = [];
                this.saveHistory();
                this.updateHistoryDisplay();
                this.showTemporaryMessage('íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            }

            bindEvents() {
                // ê¸°ì¡´ ì„ íƒì§€ ì¶”ê°€/ì œê±°
                this.addOptionBtn.addEventListener('click', () => this.addOption());
                this.removeOptionBtn.addEventListener('click', () => this.removeOption());
                
                // ê²Œì„ ì‹œì‘
                this.startGameBtn.addEventListener('click', () => this.startGame());
                
                // ì‚¬ë‹¤ë¦¬ ì‹¤í–‰
                this.runLadderBtn.addEventListener('click', () => this.runLadder());
                
                // ê²Œì„ ì¬ì‹œì‘
                this.newGameBtn.addEventListener('click', () => this.newGame());
                this.playAgainBtn.addEventListener('click', () => this.runLadder());
                this.changeOptionsBtn.addEventListener('click', () => this.changeOptions());
                
                // íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥
                this.clearHistoryBtn.addEventListener('click', () => {
                    if (confirm('ì •ë§ ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        this.clearHistory();
                    }
                });
                
                // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
                this.optionsContainer.addEventListener('input', () => this.updateUI());
                this.optionsContainer.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.startGame();
                    }
                });
            }

            addOption() {
                const currentCount = this.optionsContainer.children.length;
                if (currentCount >= 8) return;

                const newOption = document.createElement('div');
                newOption.className = 'option-input fade-in';
                newOption.innerHTML = `
                    <div class="option-number">${currentCount + 1}</div>
                    <input type="text" class="option-text" placeholder="ì„ íƒì§€ ${currentCount + 1} ğŸ’«" maxlength="20">
                `;
                
                this.optionsContainer.appendChild(newOption);
                this.updateUI();
                
                // ìƒˆë¡œ ì¶”ê°€ëœ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                const newInput = newOption.querySelector('.option-text');
                setTimeout(() => newInput.focus(), 100);
            }

            removeOption() {
                const currentCount = this.optionsContainer.children.length;
                if (currentCount <= 2) return;

                this.optionsContainer.removeChild(this.optionsContainer.lastElementChild);
                this.updateUI();
            }

            updateUI() {
                const inputs = this.optionsContainer.querySelectorAll('.option-text');
                const currentCount = inputs.length;
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                this.addOptionBtn.disabled = currentCount >= 8;
                this.removeOptionBtn.disabled = currentCount <= 2;
                
                // ì‹œì‘ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ ì²´í¬
                const filledOptions = Array.from(inputs).filter(input => input.value.trim() !== '');
                this.startGameBtn.disabled = filledOptions.length < 2;
                
                // ì„ íƒì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
                inputs.forEach((input, index) => {
                    const numberElement = input.parentElement.querySelector('.option-number');
                    numberElement.textContent = index + 1;
                });
            }

            getOptionsFromInputs() {
                const inputs = this.optionsContainer.querySelectorAll('.option-text');
                return Array.from(inputs)
                    .map(input => input.value.trim())
                    .filter(value => value !== '');
            }

            startGame() {
                this.options = this.getOptionsFromInputs();
                if (this.options.length < 2) return;

                // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                this.addToHistory(this.options);

                this.generateLadder();
                this.drawLadder();
                this.showGameCanvas();
            }

            generateLadder() {
                const optionCount = this.options.length;
                const ladderHeight = 12; // ì‚¬ë‹¤ë¦¬ ì¸µ ê°œìˆ˜ ì¡°ì •
                
                // ì‚¬ë‹¤ë¦¬ êµ¬ì¡° ìƒì„±
                this.ladderData = {
                    options: this.options,
                    connections: []
                };

                // ê° ì¸µì— ëŒ€í•´ ê°€ë¡œì¤„ ìƒì„± (ê°œì„ ëœ ì•Œê³ ë¦¬ì¦˜)
                for (let level = 0; level < ladderHeight; level++) {
                    const levelConnections = [];
                    
                    // ê° ì¹¸ì— ëŒ€í•´ ê°œë³„ì ìœ¼ë¡œ ê°€ë¡œì¤„ ìƒì„± ì—¬ë¶€ ê²°ì •
                    for (let i = 0; i < optionCount - 1; i++) {
                        // ì´ì „ì— ê°€ë¡œì¤„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ 50% í™•ë¥ ë¡œ ìƒì„±
                        if (!levelConnections.includes(i - 1) && Math.random() < 0.5) {
                            levelConnections.push(i);
                        }
                    }
                    
                    this.ladderData.connections.push(levelConnections);
                }
                
                // ìµœì†Œí•œì˜ ì—°ê²°ì„± ë³´ì¥ - ê° êµ¬ê°„ì— ìµœì†Œ 1ê°œì˜ ê°€ë¡œì¤„
                this.ensureConnectivity();
            }

            ensureConnectivity() {
                const connections = this.ladderData.connections;
                const optionCount = this.options.length;
                const sectionsCount = Math.ceil(connections.length / 3); // 3ì¸µì”© êµ¬ê°„ ë‚˜ëˆ„ê¸°
                
                for (let section = 0; section < sectionsCount; section++) {
                    const startLevel = section * 3;
                    const endLevel = Math.min(startLevel + 3, connections.length);
                    
                    // ì´ êµ¬ê°„ì— ê°€ë¡œì¤„ì´ ìˆëŠ”ì§€ í™•ì¸
                    let hasConnection = false;
                    for (let level = startLevel; level < endLevel; level++) {
                        if (connections[level].length > 0) {
                            hasConnection = true;
                            break;
                        }
                    }
                    
                    // ê°€ë¡œì¤„ì´ ì—†ë‹¤ë©´ ì¤‘ê°„ ì¸µì— í•˜ë‚˜ ì¶”ê°€
                    if (!hasConnection && endLevel > startLevel) {
                        const middleLevel = startLevel + Math.floor((endLevel - startLevel) / 2);
                        const randomColumn = Math.floor(Math.random() * (optionCount - 1));
                        connections[middleLevel].push(randomColumn);
                    }
                }
            }

            drawLadder() {
                const canvas = this.canvas;
                const ctx = this.ctx;
                const options = this.ladderData.options;
                const connections = this.ladderData.connections;
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
                const containerWidth = Math.min(window.innerWidth - 40, 400);
                canvas.width = containerWidth;
                canvas.height = 500; // ë†’ì´ ì ì ˆíˆ ì¡°ì •
                
                // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ê·¸ë¦¬ê¸° ë³€ìˆ˜ ì„¤ì •
                const padding = 50;
                const ladderWidth = canvas.width - (padding * 2);
                const ladderHeight = 320; // ì‚¬ë‹¤ë¦¬ ë†’ì´ ì¡°ì •
                const columnWidth = ladderWidth / Math.max(1, options.length - 1);
                const rowHeight = ladderHeight / connections.length;
                const startY = 80;
                
                ctx.lineCap = 'round';
                
                // ì„¸ë¡œì¤„ ê·¸ë¦¬ê¸° (ì—°ì†ì ìœ¼ë¡œ)
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                
                for (let i = 0; i < options.length; i++) {
                    const x = options.length === 1 ? canvas.width / 2 : padding + (i * columnWidth);
                    
                    ctx.beginPath();
                    ctx.moveTo(x, startY);
                    ctx.lineTo(x, startY + ladderHeight);
                    ctx.stroke();
                }
                
                // ê°€ë¡œì¤„ ê·¸ë¦¬ê¸° (ì„¸ë¡œì¤„ê³¼ ì •í™•íˆ ì—°ê²°)
                ctx.strokeStyle = '#764ba2';
                ctx.lineWidth = 3;
                
                connections.forEach((levelConnections, level) => {
                    const y = startY + (level + 0.5) * rowHeight;
                    
                    levelConnections.forEach(startCol => {
                        if (startCol < options.length - 1) {
                            const startX = options.length === 1 ? canvas.width / 2 : padding + (startCol * columnWidth);
                            const endX = options.length === 1 ? canvas.width / 2 : padding + ((startCol + 1) * columnWidth);
                            
                            ctx.beginPath();
                            ctx.moveTo(startX, y);
                            ctx.lineTo(endX, y);
                            ctx.stroke();
                        }
                    });
                });
                
                // ìƒë‹¨ì— "JJâ™¥UK" í‘œì‹œ
                const centerX = canvas.width / 2;
                
                // í•˜íŠ¸ ëª¨ì–‘ ì‹œì‘ì 
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ’•', centerX, 35);
                
                // ì»¤í”Œ ì´ë¦„
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 14px sans-serif';
                ctx.fillText('JJâ™¥UK', centerX, 55);
                
                // ì‹œì‘ì ì—ì„œ ì¤‘ì•™ ì„¸ë¡œì¤„ê¹Œì§€ ì—°ê²°ì„ 
                let startColumnX;
                if (options.length === 1) {
                    startColumnX = centerX;
                } else {
                    const centerColumn = Math.floor(options.length / 2);
                    startColumnX = padding + (centerColumn * columnWidth);
                }
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX, 60);
                ctx.lineTo(startColumnX, startY);
                ctx.stroke();
                
                // í•˜ë‹¨ì— ì„ íƒì§€ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
                ctx.textAlign = 'center';
                
                options.forEach((option, i) => {
                    const x = options.length === 1 ? centerX : padding + (i * columnWidth);
                    
                    // ë°°ê²½ ì›
                    ctx.fillStyle = '#f0f3ff';
                    ctx.beginPath();
                    ctx.arc(x, startY + ladderHeight + 30, 20, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // í…Œë‘ë¦¬
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // ë²ˆí˜¸
                    ctx.fillStyle = '#667eea';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.fillText((i + 1).toString(), x, startY + ladderHeight + 35);
                    
                    // ì„ íƒì§€ í…ìŠ¤íŠ¸
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 11px sans-serif';
                    const maxWidth = options.length === 1 ? 100 : columnWidth - 10;
                    this.wrapText(ctx, option, x, startY + ladderHeight + 55, maxWidth, 14);
                });
            }

            wrapText(ctx, text, x, y, maxWidth, lineHeight) {
                if (ctx.measureText(text).width <= maxWidth) {
                    ctx.fillText(text, x, y);
                    return;
                }
                
                // í…ìŠ¤íŠ¸ê°€ ê¸¸ë©´ ì¤„ë°”ê¿ˆ
                const words = text.split('');
                let line = '';
                let testLine = '';
                
                for (let n = 0; n < words.length; n++) {
                    testLine = line + words[n];
                    if (ctx.measureText(testLine).width > maxWidth && line !== '') {
                        ctx.fillText(line, x, y);
                        line = words[n];
                        y += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, x, y);
            }

            runLadder() {
                if (this.isAnimating) return;
                
                this.isAnimating = true;
                this.runLadderBtn.disabled = true;
                this.resultArea.classList.remove('active');
                
                // ì¤‘ì•™ì—ì„œ ì‹œì‘
                const centerColumn = Math.floor(this.options.length / 2);
                this.tracePath(centerColumn);
            }

            tracePath(startColumn) {
                const connections = this.ladderData.connections;
                let currentColumn = startColumn;
                this.selectedPath = [{ column: currentColumn, level: -1, x: this.canvas.width / 2, y: 60 }];
                
                const padding = 50;
                const ladderWidth = this.canvas.width - (padding * 2);
                const columnWidth = this.options.length === 1 ? 0 : ladderWidth / (this.options.length - 1);
                const rowHeight = 320 / connections.length; // ë†’ì´ ì¡°ì •
                const startY = 80;
                
                // ì²« ë²ˆì§¸ ì„¸ë¡œì¤„ ìœ„ì¹˜ ì¶”ê°€
                const firstColumnX = this.options.length === 1 ? this.canvas.width / 2 : padding + (currentColumn * columnWidth);
                this.selectedPath.push({ 
                    column: currentColumn, 
                    level: -0.5, 
                    x: firstColumnX, 
                    y: startY 
                });
                
                // ê²½ë¡œ ì¶”ì 
                connections.forEach((levelConnections, level) => {
                    const currentY = startY + (level + 0.5) * rowHeight;
                    
                    // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ë¡œì¤„ì´ ìˆëŠ”ì§€ í™•ì¸
                    if (levelConnections.includes(currentColumn)) {
                        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™
                        currentColumn = Math.min(currentColumn + 1, this.options.length - 1);
                    } else if (levelConnections.includes(currentColumn - 1)) {
                        // ì™¼ìª½ìœ¼ë¡œ ì´ë™
                        currentColumn = Math.max(currentColumn - 1, 0);
                    }
                    
                    const currentX = this.options.length === 1 ? this.canvas.width / 2 : padding + (currentColumn * columnWidth);
                    this.selectedPath.push({ 
                        column: currentColumn, 
                        level: level, 
                        x: currentX, 
                        y: currentY 
                    });
                });
                
                // ìµœì¢… ë„ì°©ì  ì¶”ê°€
                const finalX = this.options.length === 1 ? this.canvas.width / 2 : padding + (currentColumn * columnWidth);
                const finalY = startY + 320; // ë†’ì´ ì¡°ì •
                this.selectedPath.push({ 
                    column: currentColumn, 
                    level: connections.length, 
                    x: finalX, 
                    y: finalY 
                });
                
                // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                this.currentStep = 0;
                this.animatePath();
            }

            animatePath() {
                if (this.currentStep >= this.selectedPath.length - 1) {
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ
                    this.isAnimating = false;
                    this.runLadderBtn.disabled = false;
                    this.showResult();
                    return;
                }
                
                // í˜„ì¬ ë‹¨ê³„ ê·¸ë¦¬ê¸°
                this.drawLadder();
                this.highlightPath(this.currentStep);
                
                this.currentStep++;
                setTimeout(() => this.animatePath(), 350); // ì ì ˆí•œ ì†ë„ë¡œ ì¡°ì •
            }

            animatePath() {
                if (this.currentStep >= this.selectedPath.length - 1) {
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ
                    this.isAnimating = false;
                    this.runLadderBtn.disabled = false;
                    this.showResult();
                    return;
                }
                
                // í˜„ì¬ ë‹¨ê³„ ê·¸ë¦¬ê¸°
                this.drawLadder();
                this.highlightPath(this.currentStep);
                
                this.currentStep++;
                setTimeout(() => this.animatePath(), 350); // ì ì ˆí•œ ì†ë„ë¡œ ì¡°ì •
            }

            highlightPath(step) {
                const ctx = this.ctx;
                const path = this.selectedPath.slice(0, step + 2);
                
                // ê²½ë¡œ ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#9c27b0';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                
                for (let i = 0; i < path.length - 1; i++) {
                    const current = path[i];
                    const next = path[i + 1];
                    
                    ctx.beginPath();
                    ctx.moveTo(current.x, current.y);
                    ctx.lineTo(next.x, next.y);
                    ctx.stroke();
                }
                
                // í˜„ì¬ ìœ„ì¹˜ì— í•˜íŠ¸ í‘œì‹œ
                if (step < path.length - 1) {
                    const current = path[step + 1];
                    
                    // í•˜íŠ¸ ì£¼ë³€ì— ì›í˜• ë°°ê²½
                    ctx.fillStyle = 'rgba(156, 39, 176, 0.2)';
                    ctx.beginPath();
                    ctx.arc(current.x, current.y - 5, 15, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // í•˜íŠ¸ ì´ëª¨ì§€
                    ctx.fillStyle = '#9c27b0';
                    ctx.font = 'bold 18px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('ğŸ’–', current.x, current.y + 2);
                }
            }

            showResult() {
                const finalColumn = this.selectedPath[this.selectedPath.length - 1].column;
                const selectedOption = this.options[finalColumn];
                
                this.resultOption.textContent = `${selectedOption} ğŸ’•`;
                this.resultArea.classList.add('active');
                
                // ê²°ê³¼ ì• ë‹ˆë©”ì´ì…˜
                this.resultOption.style.animation = 'none';
                setTimeout(() => {
                    this.resultOption.style.animation = 'heartBeat 1s ease-in-out 3';
                }, 100);
            }

            showGameCanvas() {
                this.inputSection.style.display = 'none';
                this.gameCanvasArea.classList.add('active');
                this.resultArea.classList.remove('active');
            }

            newGame() {
                this.inputSection.style.display = 'block';
                this.gameCanvasArea.classList.remove('active');
                this.resultArea.classList.remove('active');
                this.isAnimating = false;
                this.runLadderBtn.disabled = false;
            }

            changeOptions() {
                this.newGame();
            }
        }

        // ê²Œì„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new CoupleLadderGame();
            
            // PWA ìŠ¤íƒ€ì¼ ì¶”ê°€
            const style = document.createElement('style');
            style.textContent = `
                @media (display-mode: standalone) {
                    body {
                        padding-top: env(safe-area-inset-top);
                        padding-bottom: env(safe-area-inset-bottom);
                    }
                    .container {
                        padding-top: calc(20px + env(safe-area-inset-top));
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
